import { Utils } from '../../utils';
import { Hit } from './../../models/hit';
import { Rect } from './../../models/rect';
import { SearchResult } from './../../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let canvasIndex = -1;
                let label;
                const rects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    for (const resource of resources) {
                        canvasIndex = this.findSequenceIndex(resource);
                        label = this.findLabel(canvasIndex);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new Rect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                            });
                            rects.push(rect);
                        }
                    }
                }
                searchResult.add(new Hit({
                    id: id,
                    index: canvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    rects: rects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvaWlpZi9zZWFyY2gtcmVzdWx0LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFPekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQ1UsQ0FBUyxFQUNULFFBQWtCLEVBQ2xCLGdCQUFrQyxFQUNsQyxNQUF3QjtRQUh4QixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBQy9CLENBQUM7SUFFRyxLQUFLO1FBQ1YsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN4QyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRTtZQUN2RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVksRUFBRSxLQUFhLEVBQUUsRUFBRTtnQkFDakUsTUFBTSxFQUFFLEdBQVcsS0FBSyxDQUFDO2dCQUN6QixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDckIsSUFBSSxLQUFLLENBQUM7Z0JBQ1YsTUFBTSxL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QUssQ0FBQztZQUMvQixDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ2hCLENBQUM7SUFFTyxRQUFRLENBQUMsS0FBYTtRQUM1QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEtBQWE7UUFDcEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELE9BQU8sTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQztJQUN2RSxDQUFDO0lBRU8sVUFBVSxDQUFDLEtBQWEsRUFBRSxLQUFhO1FBQzdDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1pbWVWaWV3ZXJDb25maWcgfSBmcm9tICcuLi8uLi9taW1lLXZpZXdlci1jb25maWcnO1xuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBIaXQgfSBmcm9tICcuLy4uLy4uL21vZGVscy9oaXQnO1xuaW1wb3J0IHtcbiAgSGl0IGFzIElpaWZIaXQsXG4gIElpaWZTZWFyY2hSZXN1bHQsXG4gIFJlc291cmNlIGFzIElpaWZSZXNvdXJjZSxcbn0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvaWlpZi1zZWFyY2gtcmVzdWx0JztcbmltcG9ydCB7IENhbnZhcywgTWFuaWZlc3QsIFNlcXVlbmNlIH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvbWFuaWZlc3QnO1xuaW1wb3J0IHsgUmVjdCB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL3JlY3QnO1xuaW1wb3J0IHsgU2VhcmNoUmVzdWx0IH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvc2VhcmNoLXJlc3VsdCc7XG5cbmV4cG9ydCBjbGFzcyBTZWFyY2hSZXN1bHRCdWlsZGVyIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBxOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBtYW5pZmVzdDogTWFuaWZlc3QsXG4gICAgcHJpdmF0ZSBpaWlmU2VhcmNoUmVzdWx0OiBJaWlmU2VhcmNoUmVzdWx0LFxuICAgIHByaXZhdGUgY29uZmlnOiBNaW1lVmlld2VyQ29uZmlnXG4gICkge31cblxuICBwdWJsaWMgYnVpbGQoKTogU2VhcmNoUmVzdWx0IHtcbiAgICBjb25zdCBzZWFyY2hSZXN1bHQgPSBuZXcgU2VhcmNoUmVzdWx0KCk7XG4gICAgc2VhcmNoUmVzdWx0LnEgPSB0aGlzLnE7XG4gICAgaWYgKHRoaXMuaWlpZlNlYXJjaFJlc3VsdCAmJiB0aGlzLmlpaWZTZWFyY2hSZXN1bHQuaGl0cykge1xuICAgICAgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMuZm9yRWFjaCgoaGl0OiBJaWlmSGl0LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGlkOiBudW1iZXIgPSBpbmRleDtcbiAgICAgICAgbGV0IGNhbnZhc0luZGV4ID0gLTE7XG4gICAgICAgIGxldCBsYWJlbDtcbiAgICAgICAgY29uc3QgcmVjdHM6IFJlY3RbXSA9IFtdO1xuICAgICAgICBpZiAodGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXMgJiYgdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXNbMF0uY2FudmFzZXMpIHtcbiAgICAgICAgICBjb25zdCByZXNvdXJjZXMgPSB0aGlzLmZpbmRSZXNvdXJjZXMoaGl0KTtcbiAgICAgICAgICBmb3IgKGNvbnN0IHJlc291cmNlIG9mIHJlc291cmNlcykge1xuICAgICAgICAgICAgY2FudmFzSW5kZXggPSB0aGlzLmZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlKTtcbiAgICAgICAgICAgIGxhYmVsID0gdGhpcy5maW5kTGFiZWwoY2FudmFzSW5kZXgpO1xuICAgICAgICAgICAgY29uc3Qgb24gPSByZXNvdXJjZS5vbjtcbiAgICAgICAgICAgIGlmIChvbikge1xuICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IHRoaXMuZ2V0U2NhbGUoY2FudmFzSW5kZXgpO1xuICAgICAgICAgICAgICBjb25zdCBjb29yZHMgPSBvbi5zdWJzdHJpbmcob24uaW5kZXhPZignPScpICsgMSkuc3BsaXQoJywnKTtcbiAgICAgICAgICAgICAgY29uc3QgcmVjdCA9IG5ldyBSZWN0KHtcbiAgICAgICAgICAgICAgICB4OiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzBdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgeTogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1sxXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIHdpZHRoOiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzJdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzNdLCBzY2FsZSksXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICByZWN0cy5wdXNoKHJlY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNlYXJjaFJlc3VsdC5hZGQoXG4gICAgICAgICAgbmV3IEhpdCh7XG4gICAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgICBpbmRleDogY2FudmFzSW5kZXgsXG4gICAgICAgICAgICBsYWJlbDogbGFiZWwsXG4gICAgICAgICAgICBtYXRjaDogaGl0Lm1hdGNoLFxuICAgICAgICAgICAgYmVmb3JlOiBoaXQuYmVmb3JlLFxuICAgICAgICAgICAgYWZ0ZXI6IGhpdC5hZnRlcixcbiAgICAgICAgICAgIHJlY3RzOiByZWN0cyxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBzZWFyY2hSZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRSZXNvdXJjZXMoaGl0OiBJaWlmSGl0KTogSWlpZlJlc291cmNlW10ge1xuICAgIGNvbnN0IHJlc291cmNlczogSWlpZlJlc291cmNlW10gPSBbXTtcbiAgICBpZiAoaGl0LmFubm90YXRpb25zKSB7XG4gICAgICBmb3IgKGNvbnN0IGFubm90YXRpb24gb2YgaGl0LmFubm90YXRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQucmVzb3VyY2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzID0gdGhpcy5paWlmU2VhcmNoUmVzdWx0LnJlc291cmNlcy5maW5kKFxuICAgICAgICAgICAgKHI6IElpaWZSZXNvdXJjZSkgPT4gclsnQGlkJ10gPT09IGFubm90YXRpb25cbiAgICAgICAgICApO1xuICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHJlc291cmNlcy5wdXNoKHJlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXNvdXJjZXM7XG4gIH1cblxuICBwcml2YXRlIGZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlOiBJaWlmUmVzb3VyY2UpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2VxdWVuY2VzIGZvdW5kIScpO1xuICAgIH1cbiAgICBjb25zdCBmaXJzdFNlcXVlbmNlID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlKCk7XG4gICAgY29uc3Qgb24gPSByZXNvdXJjZS5vbjtcbiAgICBpZiAob24gJiYgZmlyc3RTZXF1ZW5jZSAmJiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzKSB7XG4gICAgICBjb25zdCBpZCA9IG9uLnN1YnN0cmluZygwLCBvbi5pbmRleE9mKCcjJykpO1xuICAgICAgcmV0dXJuIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMuZmluZEluZGV4KChjKSA9PiBjLmlkID09PSBpZCk7XG4gICAgfVxuICAgIHJldHVybiAtMTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZExhYmVsKGluZGV4OiBudW1iZXIpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleCk7XG4gICAgICByZXR1cm4gY2FudmFzID8gY2FudmFzLmxhYmVsIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rmlyc3RTZXF1ZW5jZSgpOiBTZXF1ZW5jZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgc2VxdWVuY2VzID0gdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXM7XG4gICAgcmV0dXJuIHNlcXVlbmNlcyA/IHNlcXVlbmNlc1swXSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleDogbnVtYmVyKTogQ2FudmFzIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBmaXJzdFNlcXVlbmNlID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlKCk7XG4gICAgcmV0dXJuIGZpcnN0U2VxdWVuY2UgJiYgZmlyc3RTZXF1ZW5jZS5jYW52YXNlcyAhPT0gdW5kZWZpbmVkXG4gICAgICA/IGZpcnN0U2VxdWVuY2UuY2FudmFzZXNbaW5kZXhdXG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2NhbGUoaW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3QgcGh5c2ljYWxTY2FsZSA9IHRoaXMuZ2V0UGh5c2ljYWxTY2FsZShpbmRleCk7XG4gICAgcmV0dXJuIFV0aWxzLmdldFNjYWxlRmFjdG9yKHBoeXNpY2FsU2NhbGUsIHRoaXMuY29uZmlnLmlnbm9yZVBoeXNpY2FsU2NhbGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQaHlzaWNhbFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleCk7XG4gICAgcmV0dXJuIGNhbnZhcz8uaW1hZ2VzPy5bMF0ucmVzb3VyY2U/LnNlcnZpY2U/LnNlcnZpY2U/LnBoeXNpY2FsU2NhbGU7XG4gIH1cblxuICBwcml2YXRlIHNjYWxlVmFsdWUodmFsdWU6IHN0cmluZywgc2NhbGU6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgudHJ1bmMocGFyc2VJbnQodmFsdWUsIDEwKSAqIHNjYWxlKTtcbiAgfVxufVxuIl19