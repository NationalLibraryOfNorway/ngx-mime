import * as d3 from 'd3';
import * as OpenSeadragon from 'openseadragon';
import { ViewerOptions } from '../models/viewer-options';
import { Rect } from '../models/rect';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
export class CanvasGroupMask {
    constructor(viewer, styleService) {
        this.styleService = styleService;
        this.disableResize = false;
        this.destroyed = new Subject();
        this.animationHandler = () => {
            this.resize();
        };
        this.resizeHandler = () => {
            this.setCenter();
            this.resize();
        };
        this.canvasGroupPinchHandler = () => {
            this.disableResize = false;
        };
        this.canvasGroupDragHandler = (e) => {
            if ((e.delta.x || e.delta.y) && e.speed > 0 && e.direction !== 0) {
                this.disableResize = true;
            }
        };
        this.canvasGroupDragEndHandler = () => {
            this.disableResize = false;
            this.resize();
        };
        this.viewer = viewer;
        styleService.onChange.pipe(takeUntil(this.destroyed)).subscribe(c => {
            this.backgroundColor = c;
            if (this.leftMask) {
                this.leftMask.style('fill', this.backgroundColor);
            }
            if (this.rightMask) {
                this.rightMask.style('fill', this.backgroundColor);
            }
        });
    }
    initialise(pageBounds, visible) {
        this.canvasGroupRect = pageBounds;
        this.addCanvasGroupMask();
        this.setCenter();
        this.resize();
        if (visible) {
            this.show();
        }
        else {
            this.hide();
        }
    }
    destroy() {
        this.destroyed.next();
        this.destroyed.complete();
    }
    changeCanvasGroup(pageBounds) {
        this.canvasGroupRect = pageBounds;
        this.resize();
    }
    show() {
        this.addHandlers();
        if (!this.leftMask || !this.rightMask) {
            return;
        }
        this.setCenter();
        this.resize();
        this.leftMask.attr('height', '100%');
        this.rightMask.attr('height', '100%');
    }
    hide() {
        this.removeHandlers();
        if (!this.leftMask || !this.rightMask) {
            return;
        }
        this.leftMask.attr('height', '0');
        this.rightMask.attr('height', '0');
    }
    addHandlers() {
        this.viewer.addHandler('animation', this.animationHandler);
        this.viewer.addHandler('resize', this.resizeHandler);
        this.viewer.addHandler('canvas-pinch', this.canvasGroupPinchHandler);
        this.viewer.addHandler('canvas-drag', this.canvasGroupDragHandler);
        this.viewer.addHandler('canvas-drag-end', this.canvasGroupDragEndHandler);
    }
    removeHandlers() {
        this.viewer.removeHandler('animation', this.animationHandler);
        this.viewer.removeHandler('resize', this.resizeHandler);
        this.viewer.removeHandler('canvas-pinch', this.canvasGroupPinchHandler);
        this.viewer.removeHandler('canvas-drag', this.canvasGroupDragHandler);
        this.viewer.removeHandler('canvas-drag-end', this.canvasGroupDragEndHandler);
    }
    addCanvasGroupMask() {
        const overlays = d3.select(this.viewer.svgOverlay().node().parentNode);
        const mask = overlays.append('g').attr('id', 'page-mask');
        this.leftMask = mask
            .append('rect')
            .attr('id', 'mime-left-page-mask')
            .attr('height', '100%')
            .attr('y', 0)
            .style('fill', this.backgroundColor);
        this.rightMask = mask
            .append('rect')
            .attr('id', 'mime-right-page-mask')
            .attr('height', '100%')
            .attr('y', 0)
            .style('fill', this.backgroundColor);
    }
    setCenter() {
        this.center = new OpenSeadragon.Point(this.viewer.viewport._containerInnerSize.x / 2, this.viewer.viewport._containerInnerSize.y / 2);
    }
    resize() {
        if (this.disableResize || !this.leftMask || !this.rightMask) {
            return;
        }
        const leftMaskRect = this.getLeftMaskRect();
        const rightMaskRect = this.getRightMaskRect();
        this.leftMask.attr('width', leftMaskRect.width).attr('x', leftMaskRect.x);
        this.rightMask
            .attr('width', rightMaskRect.width)
            .attr('x', Math.round(rightMaskRect.x));
    }
    getLeftMaskRect() {
        const imgBounds = new OpenSeadragon.Rect(this.canvasGroupRect.x, this.canvasGroupRect.y, this.canvasGroupRect.width, this.canvasGroupRect.height);
        const topLeft = this.viewer.viewport.viewportToViewerElementCoordinates(imgBounds.getTopLeft());
        let width = topLeft.x - ViewerOptions.overlays.canvasGroupMarginInPageView;
        if (width < 0) {
            width = 0;
        }
        return new Rect({
            x: 0,
            width: width
        });
    }
    getRightMaskRect() {
        const imgBounds = new OpenSeadragon.Rect(this.canvasGroupRect.x, this.canvasGroupRect.y, this.canvasGroupRect.width, this.canvasGroupRect.height);
        const topRight = this.viewer.viewport.viewportToViewerElementCoordinates(imgBounds.getTopRight());
        let width = this.viewer.viewport._containerInnerSize.x - topRight.x;
        const x = this.viewer.viewport._containerInnerSize.x -
            width +
            ViewerOptions.overlays.canvasGroupMarginInPageView;
        if (width < 0) {
            width = 0;
        }
        return new Rect({
            x: x,
            width: width
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLWdyb3VwLW1hc2suanMiLCJzb3VyY2VSb290IjoiL2hvbWUvcm9ubnltL1RlbXAvbmd4LW1pbWUvbGlicy9uZ3gtbWltZS9zcmMvIiwic291cmNlcyI6WyJsaWIvY29yZS92aWV3ZXItc2VydmljZS9jYW52YXMtZ3JvdXAtbWFzay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEtBQUssYUFBYSxNQUFNLGVBQWUsQ0FBQztBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFekQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE1BQU0sT0FBTyxlQUFlO0lBYTFCLFlBQVksTUFBVyxFQUFVLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBTjNELGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBSWQsY0FBUyxHQUFrQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBK0V6QyxxQkFBZ0IsR0FBRyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUVNLGtCQUFhLEdBQUcsR0FBRyxFQUFFO1lBQzNCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNqQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEIsQ0FBQyxDQUFDO1FBRU0sNEJBQXVCLEdBQUcsR0FBRyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzdCLENBQUMsQ0FBQztRQUVNLDJCQUFzQixHQUFHLENBQUMsQ0FBTSxFQUFFLEVBQUU7WUFDMUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FB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NUIsQ0FBQztRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGtDQUFrQyxDQUN0RSxTQUFTLENBQUMsV0FBVyxFQUFFLENBQ3hCLENBQUM7UUFDRixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNwRSxNQUFNLENBQUMsR0FDTCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQzFDLEtBQUs7WUFDTCxhQUFhLENBQUMsUUFBUSxDQUFDLDJCQUEyQixDQUFDO1FBRXJELElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNiLEtBQUssR0FBRyxDQUFDLENBQUM7U0FDWDtRQUVELE9BQU8sSUFBSSxJQUFJLENBQUM7WUFDZCxDQUFDLEVBQUUsQ0FBQztZQUNKLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZDMgZnJvbSAnZDMnO1xuaW1wb3J0ICogYXMgT3BlblNlYWRyYWdvbiBmcm9tICdvcGVuc2VhZHJhZ29uJztcblxuaW1wb3J0IHsgVmlld2VyT3B0aW9ucyB9IGZyb20gJy4uL21vZGVscy92aWV3ZXItb3B0aW9ucyc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uL21vZGVscy9wb2ludCc7XG5pbXBvcnQgeyBSZWN0IH0gZnJvbSAnLi4vbW9kZWxzL3JlY3QnO1xuaW1wb3J0IHsgU3R5bGVTZXJ2aWNlIH0gZnJvbSAnLi4vc3R5bGUtc2VydmljZS9zdHlsZS5zZXJ2aWNlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IGNsYXNzIENhbnZhc0dyb3VwTWFzayB7XG4gIHZpZXdlcjogYW55O1xuICBjYW52YXNHcm91cFJlY3Q6IFJlY3Q7XG5cbiAgbGVmdE1hc2s6IGFueTtcbiAgcmlnaHRNYXNrOiBhbnk7XG5cbiAgZGlzYWJsZVJlc2l6ZSA9IGZhbHNlO1xuICBjZW50ZXI6IFBvaW50O1xuXG4gIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICBwcml2YXRlIGRlc3Ryb3llZDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3Iodmlld2VyOiBhbnksIHByaXZhdGUgc3R5bGVTZXJ2aWNlOiBTdHlsZVNlcnZpY2UpIHtcbiAgICB0aGlzLnZpZXdlciA9IHZpZXdlcjtcbiAgICBzdHlsZVNlcnZpY2Uub25DaGFuZ2UucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpKS5zdWJzY3JpYmUoYyA9PiB7XG4gICAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9IGM7XG4gICAgICBpZiAodGhpcy5sZWZ0TWFzaykge1xuICAgICAgICB0aGlzLmxlZnRNYXNrLnN0eWxlKCdmaWxsJywgdGhpcy5iYWNrZ3JvdW5kQ29sb3IpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucmlnaHRNYXNrKSB7XG4gICAgICAgIHRoaXMucmlnaHRNYXNrLnN0eWxlKCdmaWxsJywgdGhpcy5iYWNrZ3JvdW5kQ29sb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGluaXRpYWxpc2UocGFnZUJvdW5kczogUmVjdCwgdmlzaWJsZTogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0ID0gcGFnZUJvdW5kcztcblxuICAgIHRoaXMuYWRkQ2FudmFzR3JvdXBNYXNrKCk7XG5cbiAgICB0aGlzLnNldENlbnRlcigpO1xuICAgIHRoaXMucmVzaXplKCk7XG5cbiAgICBpZiAodmlzaWJsZSkge1xuICAgICAgdGhpcy5zaG93KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGlkZSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveWVkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3llZC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHVibGljIGNoYW5nZUNhbnZhc0dyb3VwKHBhZ2VCb3VuZHM6IFJlY3QpIHtcbiAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdCA9IHBhZ2VCb3VuZHM7XG4gICAgdGhpcy5yZXNpemUoKTtcbiAgfVxuXG4gIHB1YmxpYyBzaG93KCk6IHZvaWQge1xuICAgIHRoaXMuYWRkSGFuZGxlcnMoKTtcbiAgICBpZiAoIXRoaXMubGVmdE1hc2sgfHwgIXRoaXMucmlnaHRNYXNrKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2V0Q2VudGVyKCk7XG4gICAgdGhpcy5yZXNpemUoKTtcbiAgICB0aGlzLmxlZnRNYXNrLmF0dHIoJ2hlaWdodCcsICcxMDAlJyk7XG4gICAgdGhpcy5yaWdodE1hc2suYXR0cignaGVpZ2h0JywgJzEwMCUnKTtcbiAgfVxuXG4gIHB1YmxpYyBoaWRlKCk6IHZvaWQge1xuICAgIHRoaXMucmVtb3ZlSGFuZGxlcnMoKTtcbiAgICBpZiAoIXRoaXMubGVmdE1hc2sgfHwgIXRoaXMucmlnaHRNYXNrKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubGVmdE1hc2suYXR0cignaGVpZ2h0JywgJzAnKTtcbiAgICB0aGlzLnJpZ2h0TWFzay5hdHRyKCdoZWlnaHQnLCAnMCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRIYW5kbGVycygpIHtcbiAgICB0aGlzLnZpZXdlci5hZGRIYW5kbGVyKCdhbmltYXRpb24nLCB0aGlzLmFuaW1hdGlvbkhhbmRsZXIpO1xuICAgIHRoaXMudmlld2VyLmFkZEhhbmRsZXIoJ3Jlc2l6ZScsIHRoaXMucmVzaXplSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignY2FudmFzLXBpbmNoJywgdGhpcy5jYW52YXNHcm91cFBpbmNoSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignY2FudmFzLWRyYWcnLCB0aGlzLmNhbnZhc0dyb3VwRHJhZ0hhbmRsZXIpO1xuICAgIHRoaXMudmlld2VyLmFkZEhhbmRsZXIoJ2NhbnZhcy1kcmFnLWVuZCcsIHRoaXMuY2FudmFzR3JvdXBEcmFnRW5kSGFuZGxlcik7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUhhbmRsZXJzKCkge1xuICAgIHRoaXMudmlld2VyLnJlbW92ZUhhbmRsZXIoJ2FuaW1hdGlvbicsIHRoaXMuYW5pbWF0aW9uSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIucmVtb3ZlSGFuZGxlcigncmVzaXplJywgdGhpcy5yZXNpemVIYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5yZW1vdmVIYW5kbGVyKCdjYW52YXMtcGluY2gnLCB0aGlzLmNhbnZhc0dyb3VwUGluY2hIYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5yZW1vdmVIYW5kbGVyKCdjYW52YXMtZHJhZycsIHRoaXMuY2FudmFzR3JvdXBEcmFnSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIucmVtb3ZlSGFuZGxlcihcbiAgICAgICdjYW52YXMtZHJhZy1lbmQnLFxuICAgICAgdGhpcy5jYW52YXNHcm91cERyYWdFbmRIYW5kbGVyXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYW5pbWF0aW9uSGFuZGxlciA9ICgpID0+IHtcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzaXplSGFuZGxlciA9ICgpID0+IHtcbiAgICB0aGlzLnNldENlbnRlcigpO1xuICAgIHRoaXMucmVzaXplKCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBjYW52YXNHcm91cFBpbmNoSGFuZGxlciA9ICgpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZXNpemUgPSBmYWxzZTtcbiAgfTtcblxuICBwcml2YXRlIGNhbnZhc0dyb3VwRHJhZ0hhbmRsZXIgPSAoZTogYW55KSA9PiB7XG4gICAgaWYgKChlLmRlbHRhLnggfHwgZS5kZWx0YS55KSAmJiBlLnNwZWVkID4gMCAmJiBlLmRpcmVjdGlvbiAhPT0gMCkge1xuICAgICAgdGhpcy5kaXNhYmxlUmVzaXplID0gdHJ1ZTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBjYW52YXNHcm91cERyYWdFbmRIYW5kbGVyID0gKCkgPT4ge1xuICAgIHRoaXMuZGlzYWJsZVJlc2l6ZSA9IGZhbHNlO1xuICAgIHRoaXMucmVzaXplKCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBhZGRDYW52YXNHcm91cE1hc2soKSB7XG4gICAgY29uc3Qgb3ZlcmxheXMgPSBkMy5zZWxlY3QodGhpcy52aWV3ZXIuc3ZnT3ZlcmxheSgpLm5vZGUoKS5wYXJlbnROb2RlKTtcblxuICAgIGNvbnN0IG1hc2sgPSBvdmVybGF5cy5hcHBlbmQoJ2cnKS5hdHRyKCdpZCcsICdwYWdlLW1hc2snKTtcblxuICAgIHRoaXMubGVmdE1hc2sgPSBtYXNrXG4gICAgICAuYXBwZW5kKCdyZWN0JylcbiAgICAgIC5hdHRyKCdpZCcsICdtaW1lLWxlZnQtcGFnZS1tYXNrJylcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCAnMTAwJScpXG4gICAgICAuYXR0cigneScsIDApXG4gICAgICAuc3R5bGUoJ2ZpbGwnLCB0aGlzLmJhY2tncm91bmRDb2xvcik7XG5cbiAgICB0aGlzLnJpZ2h0TWFzayA9IG1hc2tcbiAgICAgIC5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmF0dHIoJ2lkJywgJ21pbWUtcmlnaHQtcGFnZS1tYXNrJylcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCAnMTAwJScpXG4gICAgICAuYXR0cigneScsIDApXG4gICAgICAuc3R5bGUoJ2ZpbGwnLCB0aGlzLmJhY2tncm91bmRDb2xvcik7XG4gIH1cblxuICBwcml2YXRlIHNldENlbnRlcigpOiB2b2lkIHtcbiAgICB0aGlzLmNlbnRlciA9IG5ldyBPcGVuU2VhZHJhZ29uLlBvaW50KFxuICAgICAgdGhpcy52aWV3ZXIudmlld3BvcnQuX2NvbnRhaW5lcklubmVyU2l6ZS54IC8gMixcbiAgICAgIHRoaXMudmlld2VyLnZpZXdwb3J0Ll9jb250YWluZXJJbm5lclNpemUueSAvIDJcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNpemUoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZVJlc2l6ZSB8fCAhdGhpcy5sZWZ0TWFzayB8fCAhdGhpcy5yaWdodE1hc2spIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBsZWZ0TWFza1JlY3QgPSB0aGlzLmdldExlZnRNYXNrUmVjdCgpO1xuICAgIGNvbnN0IHJpZ2h0TWFza1JlY3QgPSB0aGlzLmdldFJpZ2h0TWFza1JlY3QoKTtcbiAgICB0aGlzLmxlZnRNYXNrLmF0dHIoJ3dpZHRoJywgbGVmdE1hc2tSZWN0LndpZHRoKS5hdHRyKCd4JywgbGVmdE1hc2tSZWN0LngpO1xuICAgIHRoaXMucmlnaHRNYXNrXG4gICAgICAuYXR0cignd2lkdGgnLCByaWdodE1hc2tSZWN0LndpZHRoKVxuICAgICAgLmF0dHIoJ3gnLCBNYXRoLnJvdW5kKHJpZ2h0TWFza1JlY3QueCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMZWZ0TWFza1JlY3QoKTogUmVjdCB7XG4gICAgY29uc3QgaW1nQm91bmRzID0gbmV3IE9wZW5TZWFkcmFnb24uUmVjdChcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LngsXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdC55LFxuICAgICAgdGhpcy5jYW52YXNHcm91cFJlY3Qud2lkdGgsXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdC5oZWlnaHRcbiAgICApO1xuICAgIGNvbnN0IHRvcExlZnQgPSB0aGlzLnZpZXdlci52aWV3cG9ydC52aWV3cG9ydFRvVmlld2VyRWxlbWVudENvb3JkaW5hdGVzKFxuICAgICAgaW1nQm91bmRzLmdldFRvcExlZnQoKVxuICAgICk7XG4gICAgbGV0IHdpZHRoID0gdG9wTGVmdC54IC0gVmlld2VyT3B0aW9ucy5vdmVybGF5cy5jYW52YXNHcm91cE1hcmdpbkluUGFnZVZpZXc7XG5cbiAgICBpZiAod2lkdGggPCAwKSB7XG4gICAgICB3aWR0aCA9IDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBSZWN0KHtcbiAgICAgIHg6IDAsXG4gICAgICB3aWR0aDogd2lkdGhcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmlnaHRNYXNrUmVjdCgpOiBSZWN0IHtcbiAgICBjb25zdCBpbWdCb3VuZHMgPSBuZXcgT3BlblNlYWRyYWdvbi5SZWN0KFxuICAgICAgdGhpcy5jYW52YXNHcm91cFJlY3QueCxcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LnksXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdC53aWR0aCxcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LmhlaWdodFxuICAgICk7XG4gICAgY29uc3QgdG9wUmlnaHQgPSB0aGlzLnZpZXdlci52aWV3cG9ydC52aWV3cG9ydFRvVmlld2VyRWxlbWVudENvb3JkaW5hdGVzKFxuICAgICAgaW1nQm91bmRzLmdldFRvcFJpZ2h0KClcbiAgICApO1xuICAgIGxldCB3aWR0aCA9IHRoaXMudmlld2VyLnZpZXdwb3J0Ll9jb250YWluZXJJbm5lclNpemUueCAtIHRvcFJpZ2h0Lng7XG4gICAgY29uc3QgeCA9XG4gICAgICB0aGlzLnZpZXdlci52aWV3cG9ydC5fY29udGFpbmVySW5uZXJTaXplLnggLVxuICAgICAgd2lkdGggK1xuICAgICAgVmlld2VyT3B0aW9ucy5vdmVybGF5cy5jYW52YXNHcm91cE1hcmdpbkluUGFnZVZpZXc7XG5cbiAgICBpZiAod2lkdGggPCAwKSB7XG4gICAgICB3aWR0aCA9IDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBSZWN0KHtcbiAgICAgIHg6IHgsXG4gICAgICB3aWR0aDogd2lkdGhcbiAgICB9KTtcbiAgfVxufVxuIl19