import { HighlightRect } from '../../models/highlight-rect';
import { Utils } from '../../utils';
import { Hit } from './../../models/hit';
import { SearchResult } from './../../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let startCanvasIndex = -1;
                let label;
                const highlightRects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    resources.forEach((resource, index) => {
                        if (index === 0) {
                            startCanvasIndex = this.findSequenceIndex(resource);
                            label = this.findLabel(startCanvasIndex);
                        }
                        const canvasIndex = this.findSequenceIndex(resource);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new HighlightRect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                                canvasIndex,
                            });
                            highlightRects.push(rect);
                        }
                    });
                }
                searchResult.add(new Hit({
                    id: id,
                    index: startCanvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    highlightRects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config?.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvaWlpZi9zZWFyY2gtcmVzdWx0LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBT3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQ1UsQ0FBUyxFQUNULFFBQWtCLEVBQ2xCLGdCQUFrQyxFQUNsQyxNQUF3QjtRQUh4QixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBQy9CLENBQUM7SUFFRyxLQUFLO1FBQ1YsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN4QyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3hELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBWSxFQUFFLEtBQWEsRUFBRSxFQUFFO2dCQUNqRSxNQUFNLEVBQUUsR0FBVyxLQUFLLENBQUM7Z0JBQ3pCLElBQUksZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLElBQUksS0FBSyxDQUFDO2dCQUNW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LFFBQVEsQ0FBQyxTQUFTLENBQUM7UUFDMUMsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlDLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxLQUFhO1FBQzFDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLE9BQU8sYUFBYSxJQUFJLGFBQWEsQ0FBQyxRQUFRLEtBQUssU0FBUztZQUMxRCxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDL0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoQixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWE7UUFDNUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FDekIsYUFBYSxFQUNiLElBQUksQ0FBQyxNQUFNLEVBQUUsbUJBQW1CLENBQ2pDLENBQUM7SUFDSixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsS0FBYTtRQUNwQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEQsT0FBTyxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDO0lBQ3ZFLENBQUM7SUFFTyxVQUFVLENBQUMsS0FBYSxFQUFFLEtBQWE7UUFDN0MsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWltZVZpZXdlckNvbmZpZyB9IGZyb20gJy4uLy4uL21pbWUtdmlld2VyLWNvbmZpZyc7XG5pbXBvcnQgeyBIaWdobGlnaHRSZWN0IH0gZnJvbSAnLi4vLi4vbW9kZWxzL2hpZ2hsaWdodC1yZWN0JztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGl0IH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvaGl0JztcbmltcG9ydCB7XG4gIEhpdCBhcyBJaWlmSGl0LFxuICBJaWlmU2VhcmNoUmVzdWx0LFxuICBSZXNvdXJjZSBhcyBJaWlmUmVzb3VyY2UsXG59IGZyb20gJy4vLi4vLi4vbW9kZWxzL2lpaWYtc2VhcmNoLXJlc3VsdCc7XG5pbXBvcnQgeyBDYW52YXMsIE1hbmlmZXN0LCBTZXF1ZW5jZSB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL21hbmlmZXN0JztcbmltcG9ydCB7IFNlYXJjaFJlc3VsdCB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL3NlYXJjaC1yZXN1bHQnO1xuXG5leHBvcnQgY2xhc3MgU2VhcmNoUmVzdWx0QnVpbGRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcTogc3RyaW5nLFxuICAgIHByaXZhdGUgbWFuaWZlc3Q6IE1hbmlmZXN0LFxuICAgIHByaXZhdGUgaWlpZlNlYXJjaFJlc3VsdDogSWlpZlNlYXJjaFJlc3VsdCxcbiAgICBwcml2YXRlIGNvbmZpZzogTWltZVZpZXdlckNvbmZpZyxcbiAgKSB7fVxuXG4gIHB1YmxpYyBidWlsZCgpOiBTZWFyY2hSZXN1bHQge1xuICAgIGNvbnN0IHNlYXJjaFJlc3VsdCA9IG5ldyBTZWFyY2hSZXN1bHQoKTtcbiAgICBzZWFyY2hSZXN1bHQucSA9IHRoaXMucTtcbiAgICBpZiAodGhpcy5paWlmU2VhcmNoUmVzdWx0ICYmIHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5oaXRzKSB7XG4gICAgICB0aGlzLmlpaWZTZWFyY2hSZXN1bHQuaGl0cy5mb3JFYWNoKChoaXQ6IElpaWZIaXQsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgaWQ6IG51bWJlciA9IGluZGV4O1xuICAgICAgICBsZXQgc3RhcnRDYW52YXNJbmRleCA9IC0xO1xuICAgICAgICBsZXQgbGFiZWw7XG4gICAgICAgIGNvbnN0IGhpZ2hsaWdodFJlY3RzOiBIaWdobGlnaHRSZWN0W10gPSBbXTtcbiAgICAgICAgaWYgKHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzICYmIHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzWzBdLmNhbnZhc2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzb3VyY2VzID0gdGhpcy5maW5kUmVzb3VyY2VzKGhpdCk7XG4gICAgICAgICAgcmVzb3VyY2VzLmZvckVhY2goKHJlc291cmNlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICAgIHN0YXJ0Q2FudmFzSW5kZXggPSB0aGlzLmZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlKTtcbiAgICAgICAgICAgICAgbGFiZWwgPSB0aGlzLmZpbmRMYWJlbChzdGFydENhbnZhc0luZGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGNhbnZhc0luZGV4ID0gdGhpcy5maW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZSk7XG4gICAgICAgICAgICBjb25zdCBvbiA9IHJlc291cmNlLm9uO1xuICAgICAgICAgICAgaWYgKG9uKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNjYWxlID0gdGhpcy5nZXRTY2FsZShjYW52YXNJbmRleCk7XG4gICAgICAgICAgICAgIGNvbnN0IGNvb3JkcyA9IG9uLnN1YnN0cmluZyhvbi5pbmRleE9mKCc9JykgKyAxKS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgICBjb25zdCByZWN0ID0gbmV3IEhpZ2hsaWdodFJlY3Qoe1xuICAgICAgICAgICAgICAgIHg6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbMF0sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICB5OiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzFdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbMl0sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbM10sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICBjYW52YXNJbmRleCxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGhpZ2hsaWdodFJlY3RzLnB1c2gocmVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZWFyY2hSZXN1bHQuYWRkKFxuICAgICAgICAgIG5ldyBIaXQoe1xuICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgaW5kZXg6IHN0YXJ0Q2FudmFzSW5kZXgsXG4gICAgICAgICAgICBsYWJlbDogbGFiZWwsXG4gICAgICAgICAgICBtYXRjaDogaGl0Lm1hdGNoLFxuICAgICAgICAgICAgYmVmb3JlOiBoaXQuYmVmb3JlLFxuICAgICAgICAgICAgYWZ0ZXI6IGhpdC5hZnRlcixcbiAgICAgICAgICAgIGhpZ2hsaWdodFJlY3RzLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBzZWFyY2hSZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRSZXNvdXJjZXMoaGl0OiBJaWlmSGl0KTogSWlpZlJlc291cmNlW10ge1xuICAgIGNvbnN0IHJlc291cmNlczogSWlpZlJlc291cmNlW10gPSBbXTtcbiAgICBpZiAoaGl0LmFubm90YXRpb25zKSB7XG4gICAgICBmb3IgKGNvbnN0IGFubm90YXRpb24gb2YgaGl0LmFubm90YXRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQucmVzb3VyY2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzID0gdGhpcy5paWlmU2VhcmNoUmVzdWx0LnJlc291cmNlcy5maW5kKFxuICAgICAgICAgICAgKHI6IElpaWZSZXNvdXJjZSkgPT4gclsnQGlkJ10gPT09IGFubm90YXRpb24sXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICByZXNvdXJjZXMucHVzaChyZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzb3VyY2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZTogSWlpZlJlc291cmNlKTogbnVtYmVyIHtcbiAgICBpZiAoIXRoaXMubWFuaWZlc3Quc2VxdWVuY2VzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcXVlbmNlcyBmb3VuZCEnKTtcbiAgICB9XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgaWYgKG9uICYmIGZpcnN0U2VxdWVuY2UgJiYgZmlyc3RTZXF1ZW5jZS5jYW52YXNlcykge1xuICAgICAgY29uc3QgaWQgPSBvbi5zdWJzdHJpbmcoMCwgb24uaW5kZXhPZignIycpKTtcbiAgICAgIHJldHVybiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzLmZpbmRJbmRleCgoYykgPT4gYy5pZCA9PT0gaWQpO1xuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cblxuICBwcml2YXRlIGZpbmRMYWJlbChpbmRleDogbnVtYmVyKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXgpO1xuICAgICAgcmV0dXJuIGNhbnZhcyA/IGNhbnZhcy5sYWJlbCA6IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2UoKTogU2VxdWVuY2UgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNlcXVlbmNlcyA9IHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzO1xuICAgIHJldHVybiBzZXF1ZW5jZXMgPyBzZXF1ZW5jZXNbMF0gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXg6IG51bWJlcik6IENhbnZhcyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIHJldHVybiBmaXJzdFNlcXVlbmNlICYmIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMgIT09IHVuZGVmaW5lZFxuICAgICAgPyBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzW2luZGV4XVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHBoeXNpY2FsU2NhbGUgPSB0aGlzLmdldFBoeXNpY2FsU2NhbGUoaW5kZXgpO1xuICAgIHJldHVybiBVdGlscy5nZXRTY2FsZUZhY3RvcihcbiAgICAgIHBoeXNpY2FsU2NhbGUsXG4gICAgICB0aGlzLmNvbmZpZz8uaWdub3JlUGh5c2ljYWxTY2FsZSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQaHlzaWNhbFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleCk7XG4gICAgcmV0dXJuIGNhbnZhcz8uaW1hZ2VzPy5bMF0ucmVzb3VyY2U/LnNlcnZpY2U/LnNlcnZpY2U/LnBoeXNpY2FsU2NhbGU7XG4gIH1cblxuICBwcml2YXRlIHNjYWxlVmFsdWUodmFsdWU6IHN0cmluZywgc2NhbGU6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgudHJ1bmMocGFyc2VJbnQodmFsdWUsIDEwKSAqIHNjYWxlKTtcbiAgfVxufVxuIl19