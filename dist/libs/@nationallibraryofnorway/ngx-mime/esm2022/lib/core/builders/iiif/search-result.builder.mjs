import { HighlightRect } from '../../models/highlight-rect';
import { Utils } from '../../utils';
import { Hit } from './../../models/hit';
import { SearchResult } from './../../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let startCanvasIndex = -1;
                let label;
                const highlightRects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    resources.forEach((resource, index) => {
                        if (index === 0) {
                            startCanvasIndex = this.findSequenceIndex(resource);
                            label = this.findLabel(startCanvasIndex);
                        }
                        const canvasIndex = this.findSequenceIndex(resource);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new HighlightRect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                                canvasIndex
                            });
                            highlightRects.push(rect);
                        }
                    });
                }
                searchResult.add(new Hit({
                    id: id,
                    index: startCanvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    highlightRects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config?.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvaWlpZi9zZWFyY2gtcmVzdWx0LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBT3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQ1UsQ0FBUyxFQUNULFFBQWtCLEVBQ2xCLGdCQUFrQyxFQUNsQyxNQUF3QjtRQUh4QixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBQy9CLENBQUM7SUFFRyxLQUFLO1FBQ1YsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN4QyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3hELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBWSxFQUFFLEtBQWEsRUFBRSxFQUFFO2dCQUNqRSxNQUFNLEVBQUUsR0FBVyxLQUFLLENBQUM7Z0JBQ3pCLElBQUksZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLElBQUksS0FBSyxDQUFDO2dCQUNW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LFFBQVEsQ0FBQyxTQUFTLENBQUM7UUFDMUMsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlDLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxLQUFhO1FBQzFDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLE9BQU8sYUFBYSxJQUFJLGFBQWEsQ0FBQyxRQUFRLEtBQUssU0FBUztZQUMxRCxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDL0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoQixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWE7UUFDNUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FDekIsYUFBYSxFQUNiLElBQUksQ0FBQyxNQUFNLEVBQUUsbUJBQW1CLENBQ2pDLENBQUM7SUFDSixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsS0FBYTtRQUNwQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEQsT0FBTyxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDO0lBQ3ZFLENBQUM7SUFFTyxVQUFVLENBQUMsS0FBYSxFQUFFLEtBQWE7UUFDN0MsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWltZVZpZXdlckNvbmZpZyB9IGZyb20gJy4uLy4uL21pbWUtdmlld2VyLWNvbmZpZyc7XG5pbXBvcnQgeyBIaWdobGlnaHRSZWN0IH0gZnJvbSAnLi4vLi4vbW9kZWxzL2hpZ2hsaWdodC1yZWN0JztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGl0IH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvaGl0JztcbmltcG9ydCB7XG4gIEhpdCBhcyBJaWlmSGl0LFxuICBJaWlmU2VhcmNoUmVzdWx0LFxuICBSZXNvdXJjZSBhcyBJaWlmUmVzb3VyY2UsXG59IGZyb20gJy4vLi4vLi4vbW9kZWxzL2lpaWYtc2VhcmNoLXJlc3VsdCc7XG5pbXBvcnQgeyBDYW52YXMsIE1hbmlmZXN0LCBTZXF1ZW5jZSB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL21hbmlmZXN0JztcbmltcG9ydCB7IFNlYXJjaFJlc3VsdCB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL3NlYXJjaC1yZXN1bHQnO1xuXG5leHBvcnQgY2xhc3MgU2VhcmNoUmVzdWx0QnVpbGRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcTogc3RyaW5nLFxuICAgIHByaXZhdGUgbWFuaWZlc3Q6IE1hbmlmZXN0LFxuICAgIHByaXZhdGUgaWlpZlNlYXJjaFJlc3VsdDogSWlpZlNlYXJjaFJlc3VsdCxcbiAgICBwcml2YXRlIGNvbmZpZzogTWltZVZpZXdlckNvbmZpZ1xuICApIHt9XG5cbiAgcHVibGljIGJ1aWxkKCk6IFNlYXJjaFJlc3VsdCB7XG4gICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gbmV3IFNlYXJjaFJlc3VsdCgpO1xuICAgIHNlYXJjaFJlc3VsdC5xID0gdGhpcy5xO1xuICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQgJiYgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMpIHtcbiAgICAgIHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5oaXRzLmZvckVhY2goKGhpdDogSWlpZkhpdCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBpZDogbnVtYmVyID0gaW5kZXg7XG4gICAgICAgIGxldCBzdGFydENhbnZhc0luZGV4ID0gLTE7XG4gICAgICAgIGxldCBsYWJlbDtcbiAgICAgICAgY29uc3QgaGlnaGxpZ2h0UmVjdHM6IEhpZ2hsaWdodFJlY3RbXSA9IFtdO1xuICAgICAgICBpZiAodGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXMgJiYgdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXNbMF0uY2FudmFzZXMpIHtcbiAgICAgICAgICBjb25zdCByZXNvdXJjZXMgPSB0aGlzLmZpbmRSZXNvdXJjZXMoaGl0KTtcbiAgICAgICAgICByZXNvdXJjZXMuZm9yRWFjaCgocmVzb3VyY2UsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICAgICAgc3RhcnRDYW52YXNJbmRleCA9IHRoaXMuZmluZFNlcXVlbmNlSW5kZXgocmVzb3VyY2UpO1xuICAgICAgICAgICAgICBsYWJlbCA9IHRoaXMuZmluZExhYmVsKHN0YXJ0Q2FudmFzSW5kZXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgY2FudmFzSW5kZXggPSB0aGlzLmZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlKTtcbiAgICAgICAgICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgICAgICAgICBpZiAob24pIHtcbiAgICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSB0aGlzLmdldFNjYWxlKGNhbnZhc0luZGV4KTtcbiAgICAgICAgICAgICAgY29uc3QgY29vcmRzID0gb24uc3Vic3RyaW5nKG9uLmluZGV4T2YoJz0nKSArIDEpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBuZXcgSGlnaGxpZ2h0UmVjdCh7XG4gICAgICAgICAgICAgICAgeDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1swXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIHk6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbMV0sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1syXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1szXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIGNhbnZhc0luZGV4XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBoaWdobGlnaHRSZWN0cy5wdXNoKHJlY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgc2VhcmNoUmVzdWx0LmFkZChcbiAgICAgICAgICBuZXcgSGl0KHtcbiAgICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgICAgIGluZGV4OiBzdGFydENhbnZhc0luZGV4LFxuICAgICAgICAgICAgbGFiZWw6IGxhYmVsLFxuICAgICAgICAgICAgbWF0Y2g6IGhpdC5tYXRjaCxcbiAgICAgICAgICAgIGJlZm9yZTogaGl0LmJlZm9yZSxcbiAgICAgICAgICAgIGFmdGVyOiBoaXQuYWZ0ZXIsXG4gICAgICAgICAgICBoaWdobGlnaHRSZWN0cyxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBzZWFyY2hSZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRSZXNvdXJjZXMoaGl0OiBJaWlmSGl0KTogSWlpZlJlc291cmNlW10ge1xuICAgIGNvbnN0IHJlc291cmNlczogSWlpZlJlc291cmNlW10gPSBbXTtcbiAgICBpZiAoaGl0LmFubm90YXRpb25zKSB7XG4gICAgICBmb3IgKGNvbnN0IGFubm90YXRpb24gb2YgaGl0LmFubm90YXRpb25zKSB7XG4gICAgICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQucmVzb3VyY2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzID0gdGhpcy5paWlmU2VhcmNoUmVzdWx0LnJlc291cmNlcy5maW5kKFxuICAgICAgICAgICAgKHI6IElpaWZSZXNvdXJjZSkgPT4gclsnQGlkJ10gPT09IGFubm90YXRpb25cbiAgICAgICAgICApO1xuICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgIHJlc291cmNlcy5wdXNoKHJlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXNvdXJjZXM7XG4gIH1cblxuICBwcml2YXRlIGZpbmRTZXF1ZW5jZUluZGV4KHJlc291cmNlOiBJaWlmUmVzb3VyY2UpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2VxdWVuY2VzIGZvdW5kIScpO1xuICAgIH1cbiAgICBjb25zdCBmaXJzdFNlcXVlbmNlID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlKCk7XG4gICAgY29uc3Qgb24gPSByZXNvdXJjZS5vbjtcbiAgICBpZiAob24gJiYgZmlyc3RTZXF1ZW5jZSAmJiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzKSB7XG4gICAgICBjb25zdCBpZCA9IG9uLnN1YnN0cmluZygwLCBvbi5pbmRleE9mKCcjJykpO1xuICAgICAgcmV0dXJuIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMuZmluZEluZGV4KChjKSA9PiBjLmlkID09PSBpZCk7XG4gICAgfVxuICAgIHJldHVybiAtMTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZExhYmVsKGluZGV4OiBudW1iZXIpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleCk7XG4gICAgICByZXR1cm4gY2FudmFzID8gY2FudmFzLmxhYmVsIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rmlyc3RTZXF1ZW5jZSgpOiBTZXF1ZW5jZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgc2VxdWVuY2VzID0gdGhpcy5tYW5pZmVzdC5zZXF1ZW5jZXM7XG4gICAgcmV0dXJuIHNlcXVlbmNlcyA/IHNlcXVlbmNlc1swXSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleDogbnVtYmVyKTogQ2FudmFzIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBmaXJzdFNlcXVlbmNlID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlKCk7XG4gICAgcmV0dXJuIGZpcnN0U2VxdWVuY2UgJiYgZmlyc3RTZXF1ZW5jZS5jYW52YXNlcyAhPT0gdW5kZWZpbmVkXG4gICAgICA/IGZpcnN0U2VxdWVuY2UuY2FudmFzZXNbaW5kZXhdXG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2NhbGUoaW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3QgcGh5c2ljYWxTY2FsZSA9IHRoaXMuZ2V0UGh5c2ljYWxTY2FsZShpbmRleCk7XG4gICAgcmV0dXJuIFV0aWxzLmdldFNjYWxlRmFjdG9yKFxuICAgICAgcGh5c2ljYWxTY2FsZSxcbiAgICAgIHRoaXMuY29uZmlnPy5pZ25vcmVQaHlzaWNhbFNjYWxlXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGh5c2ljYWxTY2FsZShpbmRleDogbnVtYmVyKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXgpO1xuICAgIHJldHVybiBjYW52YXM/LmltYWdlcz8uWzBdLnJlc291cmNlPy5zZXJ2aWNlPy5zZXJ2aWNlPy5waHlzaWNhbFNjYWxlO1xuICB9XG5cbiAgcHJpdmF0ZSBzY2FsZVZhbHVlKHZhbHVlOiBzdHJpbmcsIHNjYWxlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLnRydW5jKHBhcnNlSW50KHZhbHVlLCAxMCkgKiBzY2FsZSk7XG4gIH1cbn1cbiJdfQ==