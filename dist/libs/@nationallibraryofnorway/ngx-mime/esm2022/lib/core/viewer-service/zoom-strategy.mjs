import * as d3 from 'd3';
import * as OpenSeadragon from 'openseadragon';
import { Dimensions } from '../models/dimensions';
import { ViewerLayout } from '../models/viewer-layout';
import { ViewerMode } from '../models/viewer-mode';
import { ViewerOptions } from '../models/viewer-options';
import { Utils } from '../utils';
import { ZoomUtils } from './zoom-utils';
export class ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        this.viewer = viewer;
        this.canvasService = canvasService;
        this.modeService = modeService;
        this.viewerLayoutService = viewerLayoutService;
    }
    setMinZoom(mode) {
        this.viewer.viewport.minZoomLevel = this.getHomeZoomLevel(mode);
    }
    getMinZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMinZoom(), 5);
    }
    getMaxZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMaxZoom(), 5);
    }
    getZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getZoom(true), 5);
    }
    goToHomeZoom() {
        this.zoomTo(this.getHomeZoomLevel(this.modeService.mode));
        if (this.modeService.isPageZoomed()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
    }
    zoomTo(level, position) {
        if (level !== 0) {
            this.viewer.viewport.zoomTo(level, position);
        }
    }
    getHomeZoomLevel(mode) {
        if (!this.viewer || !this.canvasService || !this.viewer.container) {
            return 1;
        }
        let currentCanvasHeight;
        let currentCanvasWidth;
        let viewportBounds;
        const currentCanvasGroupRect = this.canvasService.getCurrentCanvasGroupRect();
        currentCanvasHeight = currentCanvasGroupRect.height;
        currentCanvasWidth = currentCanvasGroupRect.width;
        viewportBounds =
            mode === ViewerMode.DASHBOARD
                ? this.getDashboardViewportBounds()
                : this.viewer.viewport.getBounds();
        return this.getFittedZoomLevel(viewportBounds, currentCanvasHeight, currentCanvasWidth);
    }
    zoomIn(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = ViewerOptions.zoom.zoomFactor;
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.modeService.mode !== ViewerMode.PAGE_ZOOMED) {
            this.modeService.mode = ViewerMode.PAGE_ZOOMED;
        }
        this.zoomBy(zoomFactor, position);
    }
    zoomOut(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = Math.pow(ViewerOptions.zoom.zoomFactor, -1);
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.isViewportLargerThanCanvasGroup()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
        else {
            this.zoomBy(zoomFactor, position);
        }
    }
    getDashboardViewportBounds() {
        const homeZoomFactor = this.getHomeZoomFactor();
        const maxViewportDimensions = new Dimensions(d3
            .select(this.viewer.container.parentNode.parentNode)
            .node()
            .getBoundingClientRect());
        const viewportHeight = maxViewportDimensions.height -
            ViewerOptions.padding.header -
            ViewerOptions.padding.footer;
        const viewportWidth = maxViewportDimensions.width * homeZoomFactor;
        const viewportSizeInViewportCoordinates = this.viewer.viewport.deltaPointsFromPixels(new OpenSeadragon.Point(viewportWidth, viewportHeight));
        return new OpenSeadragon.Rect(0, 0, viewportSizeInViewportCoordinates.x, viewportSizeInViewportCoordinates.y);
    }
    getFittedZoomLevel(viewportBounds, canvasGroupHeight, canvasGroupWidth) {
        const currentZoom = this.viewer.viewport.getZoom();
        const resizeRatio = viewportBounds.height / canvasGroupHeight;
        if (resizeRatio * canvasGroupWidth <= viewportBounds.width) {
            return Utils.shortenDecimals(resizeRatio * currentZoom, 5);
        }
        else {
            // Canvas group at full height is wider than viewport.  Return fit by width instead.
            return Utils.shortenDecimals((viewportBounds.width / canvasGroupWidth) * currentZoom, 5);
        }
    }
    zoomBy(zoomFactor, position) {
        const currentZoom = this.viewer.viewport.getZoom(false);
        zoomFactor = ZoomUtils.constraintZoomFactor(zoomFactor, currentZoom, this.getMaxZoom());
        this.viewer.viewport.zoomBy(zoomFactor, position);
    }
    isViewportLargerThanCanvasGroup() {
        const canvasGroupRec = this.canvasService.getCurrentCanvasGroupRect();
        const viewportBounds = this.viewer.viewport.getBounds();
        const pbWidth = Math.round(canvasGroupRec.width);
        const pbHeight = Math.round(canvasGroupRec.height);
        const vpWidth = Math.round(viewportBounds.width);
        const vpHeight = Math.round(viewportBounds.height);
        return vpHeight >= pbHeight || vpWidth >= pbWidth;
    }
    getHomeZoomFactor() {
        return this.modeService.mode === ViewerMode.DASHBOARD
            ? this.getDashboardZoomHomeFactor()
            : 1;
    }
    getDashboardZoomHomeFactor() {
        return this.viewerLayoutService.layout === ViewerLayout.ONE_PAGE
            ? 0.85
            : 0.66;
    }
}
export class DefaultZoomStrategy extends ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        super(viewer, canvasService, modeService, viewerLayoutService);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem9vbS1zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LW1pbWUvc3JjL2xpYi9jb3JlL3ZpZXdlci1zZXJ2aWNlL3pvb20tc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLGFBQWEsTUFBTSxlQUFlLENBQUM7QUFHL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQW9CekMsTUFBTSxPQUFPLFlBQVk7SUFDdkIsWUFDWSxNQUFXLEVBQ1gsYUFBNEIsRUFDNUIsV0FBd0IsRUFDeEIsbUJBQXdDO1FBSHhDLFdBQU0sR0FBTixNQUFNLENBQUs7UUFDWCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0lBQ2pELENBQUM7SUFFSixVQUFVLENBQUMsSUFBZ0I7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFD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QUN4QixtQkFBd0M7UUFFeEMsS0FBSyxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixDQUFDLENBQUM7SUFDakUsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZDMgZnJvbSAnZDMnO1xuaW1wb3J0ICogYXMgT3BlblNlYWRyYWdvbiBmcm9tICdvcGVuc2VhZHJhZ29uJztcbmltcG9ydCB7IENhbnZhc1NlcnZpY2UgfSBmcm9tICcuLi9jYW52YXMtc2VydmljZS9jYW52YXMtc2VydmljZSc7XG5pbXBvcnQgeyBNb2RlU2VydmljZSB9IGZyb20gJy4uL21vZGUtc2VydmljZS9tb2RlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRGltZW5zaW9ucyB9IGZyb20gJy4uL21vZGVscy9kaW1lbnNpb25zJztcbmltcG9ydCB7IERpcmVjdGlvbiB9IGZyb20gJy4uL21vZGVscy9kaXJlY3Rpb24nO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi9tb2RlbHMvcG9pbnQnO1xuaW1wb3J0IHsgVmlld2VyTGF5b3V0IH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1sYXlvdXQnO1xuaW1wb3J0IHsgVmlld2VyTW9kZSB9IGZyb20gJy4uL21vZGVscy92aWV3ZXItbW9kZSc7XG5pbXBvcnQgeyBWaWV3ZXJPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1vcHRpb25zJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgVmlld2VyTGF5b3V0U2VydmljZSB9IGZyb20gJy4uL3ZpZXdlci1sYXlvdXQtc2VydmljZS92aWV3ZXItbGF5b3V0LXNlcnZpY2UnO1xuaW1wb3J0IHsgWm9vbVV0aWxzIH0gZnJvbSAnLi96b29tLXV0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBDYW52YXNHcm91cCB7XG4gIGNhbnZhc0dyb3VwSW5kZXg6IG51bWJlcjtcbiAgY2FudmFzR3JvdXBFbmRIaXRDb3VudFJlYWNoZWQ/OiBib29sZWFuO1xuICBkaXJlY3Rpb246IERpcmVjdGlvbjtcbiAgaW1tZWRpYXRlbHk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RyYXRlZ3kge1xuICBzZXRNaW5ab29tKG1vZGU6IFZpZXdlck1vZGUpOiB2b2lkO1xuICBnZXRNaW5ab29tKCk6IG51bWJlcjtcbiAgZ2V0TWF4Wm9vbSgpOiBudW1iZXI7XG4gIGdldFpvb20oKTogbnVtYmVyO1xuICBnb1RvSG9tZVpvb20oKTogdm9pZDtcbiAgem9vbVRvKGxldmVsOiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkO1xuICB6b29tSW4oem9vbUZhY3Rvcj86IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQ7XG4gIHpvb21PdXQoem9vbUZhY3Rvcj86IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBab29tU3RyYXRlZ3kge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgdmlld2VyOiBhbnksXG4gICAgcHJvdGVjdGVkIGNhbnZhc1NlcnZpY2U6IENhbnZhc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIG1vZGVTZXJ2aWNlOiBNb2RlU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgdmlld2VyTGF5b3V0U2VydmljZTogVmlld2VyTGF5b3V0U2VydmljZVxuICApIHt9XG5cbiAgc2V0TWluWm9vbShtb2RlOiBWaWV3ZXJNb2RlKTogdm9pZCB7XG4gICAgdGhpcy52aWV3ZXIudmlld3BvcnQubWluWm9vbUxldmVsID0gdGhpcy5nZXRIb21lWm9vbUxldmVsKG1vZGUpO1xuICB9XG5cbiAgZ2V0TWluWm9vbSgpOiBudW1iZXIge1xuICAgIHJldHVybiBVdGlscy5zaG9ydGVuRGVjaW1hbHModGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0TWluWm9vbSgpLCA1KTtcbiAgfVxuXG4gIGdldE1heFpvb20oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gVXRpbHMuc2hvcnRlbkRlY2ltYWxzKHRoaXMudmlld2VyLnZpZXdwb3J0LmdldE1heFpvb20oKSwgNSk7XG4gIH1cblxuICBnZXRab29tKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyh0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRab29tKHRydWUpLCA1KTtcbiAgfVxuXG4gIGdvVG9Ib21lWm9vbSgpOiB2b2lkIHtcbiAgICB0aGlzLnpvb21Ubyh0aGlzLmdldEhvbWVab29tTGV2ZWwodGhpcy5tb2RlU2VydmljZS5tb2RlKSk7XG4gICAgaWYgKHRoaXMubW9kZVNlcnZpY2UuaXNQYWdlWm9vbWVkKCkpIHtcbiAgICAgIHRoaXMubW9kZVNlcnZpY2UubW9kZSA9IFZpZXdlck1vZGUuUEFHRTtcbiAgICB9XG4gIH1cblxuICB6b29tVG8obGV2ZWw6IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQge1xuICAgIGlmIChsZXZlbCAhPT0gMCkge1xuICAgICAgdGhpcy52aWV3ZXIudmlld3BvcnQuem9vbVRvKGxldmVsLCBwb3NpdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRIb21lWm9vbUxldmVsKG1vZGU6IFZpZXdlck1vZGUpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy52aWV3ZXIgfHwgIXRoaXMuY2FudmFzU2VydmljZSB8fCAhdGhpcy52aWV3ZXIuY29udGFpbmVyKSB7XG4gICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICBsZXQgY3VycmVudENhbnZhc0hlaWdodDogbnVtYmVyO1xuICAgIGxldCBjdXJyZW50Q2FudmFzV2lkdGg6IG51bWJlcjtcbiAgICBsZXQgdmlld3BvcnRCb3VuZHM6IGFueTtcblxuICAgIGNvbnN0IGN1cnJlbnRDYW52YXNHcm91cFJlY3QgPVxuICAgICAgdGhpcy5jYW52YXNTZXJ2aWNlLmdldEN1cnJlbnRDYW52YXNHcm91cFJlY3QoKTtcbiAgICBjdXJyZW50Q2FudmFzSGVpZ2h0ID0gY3VycmVudENhbnZhc0dyb3VwUmVjdC5oZWlnaHQ7XG4gICAgY3VycmVudENhbnZhc1dpZHRoID0gY3VycmVudENhbnZhc0dyb3VwUmVjdC53aWR0aDtcbiAgICB2aWV3cG9ydEJvdW5kcyA9XG4gICAgICBtb2RlID09PSBWaWV3ZXJNb2RlLkRBU0hCT0FSRFxuICAgICAgICA/IHRoaXMuZ2V0RGFzaGJvYXJkVmlld3BvcnRCb3VuZHMoKVxuICAgICAgICA6IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldEJvdW5kcygpO1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0Rml0dGVkWm9vbUxldmVsKFxuICAgICAgdmlld3BvcnRCb3VuZHMsXG4gICAgICBjdXJyZW50Q2FudmFzSGVpZ2h0LFxuICAgICAgY3VycmVudENhbnZhc1dpZHRoXG4gICAgKTtcbiAgfVxuXG4gIHpvb21Jbih6b29tRmFjdG9yPzogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZCB7XG4gICAgaWYgKCF6b29tRmFjdG9yKSB7XG4gICAgICB6b29tRmFjdG9yID0gVmlld2VyT3B0aW9ucy56b29tLnpvb21GYWN0b3I7XG4gICAgfVxuXG4gICAgaWYgKHBvc2l0aW9uKSB7XG4gICAgICBwb3NpdGlvbiA9IHRoaXMudmlld2VyLnZpZXdwb3J0LnBvaW50RnJvbVBpeGVsKHBvc2l0aW9uKTtcbiAgICAgIGlmIChwb3NpdGlvbikge1xuICAgICAgICBwb3NpdGlvbiA9IFpvb21VdGlscy5jb25zdHJhaW5Qb3NpdGlvblRvQ2FudmFzR3JvdXAoXG4gICAgICAgICAgcG9zaXRpb24sXG4gICAgICAgICAgdGhpcy5jYW52YXNTZXJ2aWNlLmdldEN1cnJlbnRDYW52YXNHcm91cFJlY3QoKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgIT09IFZpZXdlck1vZGUuUEFHRV9aT09NRUQpIHtcbiAgICAgIHRoaXMubW9kZVNlcnZpY2UubW9kZSA9IFZpZXdlck1vZGUuUEFHRV9aT09NRUQ7XG4gICAgfVxuXG4gICAgdGhpcy56b29tQnkoem9vbUZhY3RvciwgcG9zaXRpb24pO1xuICB9XG5cbiAgem9vbU91dCh6b29tRmFjdG9yPzogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZCB7XG4gICAgaWYgKCF6b29tRmFjdG9yKSB7XG4gICAgICB6b29tRmFjdG9yID0gTWF0aC5wb3coVmlld2VyT3B0aW9ucy56b29tLnpvb21GYWN0b3IsIC0xKTtcbiAgICB9XG5cbiAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgIHBvc2l0aW9uID0gdGhpcy52aWV3ZXIudmlld3BvcnQucG9pbnRGcm9tUGl4ZWwocG9zaXRpb24pO1xuICAgICAgaWYgKHBvc2l0aW9uKSB7XG4gICAgICAgIHBvc2l0aW9uID0gWm9vbVV0aWxzLmNvbnN0cmFpblBvc2l0aW9uVG9DYW52YXNHcm91cChcbiAgICAgICAgICBwb3NpdGlvbixcbiAgICAgICAgICB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q3VycmVudENhbnZhc0dyb3VwUmVjdCgpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNWaWV3cG9ydExhcmdlclRoYW5DYW52YXNHcm91cCgpKSB7XG4gICAgICB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPSBWaWV3ZXJNb2RlLlBBR0U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuem9vbUJ5KHpvb21GYWN0b3IsIHBvc2l0aW9uKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldERhc2hib2FyZFZpZXdwb3J0Qm91bmRzKCk6IGFueSB7XG4gICAgY29uc3QgaG9tZVpvb21GYWN0b3IgPSB0aGlzLmdldEhvbWVab29tRmFjdG9yKCk7XG4gICAgY29uc3QgbWF4Vmlld3BvcnREaW1lbnNpb25zID0gbmV3IERpbWVuc2lvbnMoXG4gICAgICBkM1xuICAgICAgICAuc2VsZWN0KHRoaXMudmlld2VyLmNvbnRhaW5lci5wYXJlbnROb2RlLnBhcmVudE5vZGUpXG4gICAgICAgIC5ub2RlKClcbiAgICAgICAgLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgKTtcbiAgICBjb25zdCB2aWV3cG9ydEhlaWdodCA9XG4gICAgICBtYXhWaWV3cG9ydERpbWVuc2lvbnMuaGVpZ2h0IC1cbiAgICAgIFZpZXdlck9wdGlvbnMucGFkZGluZy5oZWFkZXIgLVxuICAgICAgVmlld2VyT3B0aW9ucy5wYWRkaW5nLmZvb3RlcjtcbiAgICBjb25zdCB2aWV3cG9ydFdpZHRoID0gbWF4Vmlld3BvcnREaW1lbnNpb25zLndpZHRoICogaG9tZVpvb21GYWN0b3I7XG5cbiAgICBjb25zdCB2aWV3cG9ydFNpemVJblZpZXdwb3J0Q29vcmRpbmF0ZXMgPVxuICAgICAgdGhpcy52aWV3ZXIudmlld3BvcnQuZGVsdGFQb2ludHNGcm9tUGl4ZWxzKFxuICAgICAgICBuZXcgT3BlblNlYWRyYWdvbi5Qb2ludCh2aWV3cG9ydFdpZHRoLCB2aWV3cG9ydEhlaWdodClcbiAgICAgICk7XG5cbiAgICByZXR1cm4gbmV3IE9wZW5TZWFkcmFnb24uUmVjdChcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdmlld3BvcnRTaXplSW5WaWV3cG9ydENvb3JkaW5hdGVzLngsXG4gICAgICB2aWV3cG9ydFNpemVJblZpZXdwb3J0Q29vcmRpbmF0ZXMueVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpdHRlZFpvb21MZXZlbChcbiAgICB2aWV3cG9ydEJvdW5kczogYW55LFxuICAgIGNhbnZhc0dyb3VwSGVpZ2h0OiBudW1iZXIsXG4gICAgY2FudmFzR3JvdXBXaWR0aDogbnVtYmVyXG4gICkge1xuICAgIGNvbnN0IGN1cnJlbnRab29tOiBudW1iZXIgPSB0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRab29tKCk7XG4gICAgY29uc3QgcmVzaXplUmF0aW86IG51bWJlciA9IHZpZXdwb3J0Qm91bmRzLmhlaWdodCAvIGNhbnZhc0dyb3VwSGVpZ2h0O1xuXG4gICAgaWYgKHJlc2l6ZVJhdGlvICogY2FudmFzR3JvdXBXaWR0aCA8PSB2aWV3cG9ydEJvdW5kcy53aWR0aCkge1xuICAgICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyhyZXNpemVSYXRpbyAqIGN1cnJlbnRab29tLCA1KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2FudmFzIGdyb3VwIGF0IGZ1bGwgaGVpZ2h0IGlzIHdpZGVyIHRoYW4gdmlld3BvcnQuICBSZXR1cm4gZml0IGJ5IHdpZHRoIGluc3RlYWQuXG4gICAgICByZXR1cm4gVXRpbHMuc2hvcnRlbkRlY2ltYWxzKFxuICAgICAgICAodmlld3BvcnRCb3VuZHMud2lkdGggLyBjYW52YXNHcm91cFdpZHRoKSAqIGN1cnJlbnRab29tLFxuICAgICAgICA1XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgem9vbUJ5KHpvb21GYWN0b3I6IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQge1xuICAgIGNvbnN0IGN1cnJlbnRab29tID0gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Wm9vbShmYWxzZSk7XG4gICAgem9vbUZhY3RvciA9IFpvb21VdGlscy5jb25zdHJhaW50Wm9vbUZhY3RvcihcbiAgICAgIHpvb21GYWN0b3IsXG4gICAgICBjdXJyZW50Wm9vbSxcbiAgICAgIHRoaXMuZ2V0TWF4Wm9vbSgpXG4gICAgKTtcbiAgICB0aGlzLnZpZXdlci52aWV3cG9ydC56b29tQnkoem9vbUZhY3RvciwgcG9zaXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ZpZXdwb3J0TGFyZ2VyVGhhbkNhbnZhc0dyb3VwKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNhbnZhc0dyb3VwUmVjID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldEN1cnJlbnRDYW52YXNHcm91cFJlY3QoKTtcbiAgICBjb25zdCB2aWV3cG9ydEJvdW5kcyA9IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldEJvdW5kcygpO1xuICAgIGNvbnN0IHBiV2lkdGggPSBNYXRoLnJvdW5kKGNhbnZhc0dyb3VwUmVjLndpZHRoKTtcbiAgICBjb25zdCBwYkhlaWdodCA9IE1hdGgucm91bmQoY2FudmFzR3JvdXBSZWMuaGVpZ2h0KTtcbiAgICBjb25zdCB2cFdpZHRoID0gTWF0aC5yb3VuZCh2aWV3cG9ydEJvdW5kcy53aWR0aCk7XG4gICAgY29uc3QgdnBIZWlnaHQgPSBNYXRoLnJvdW5kKHZpZXdwb3J0Qm91bmRzLmhlaWdodCk7XG4gICAgcmV0dXJuIHZwSGVpZ2h0ID49IHBiSGVpZ2h0IHx8IHZwV2lkdGggPj0gcGJXaWR0aDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SG9tZVpvb21GYWN0b3IoKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kZVNlcnZpY2UubW9kZSA9PT0gVmlld2VyTW9kZS5EQVNIQk9BUkRcbiAgICAgID8gdGhpcy5nZXREYXNoYm9hcmRab29tSG9tZUZhY3RvcigpXG4gICAgICA6IDE7XG4gIH1cblxuICBwcml2YXRlIGdldERhc2hib2FyZFpvb21Ib21lRmFjdG9yKCkge1xuICAgIHJldHVybiB0aGlzLnZpZXdlckxheW91dFNlcnZpY2UubGF5b3V0ID09PSBWaWV3ZXJMYXlvdXQuT05FX1BBR0VcbiAgICAgID8gMC44NVxuICAgICAgOiAwLjY2O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEZWZhdWx0Wm9vbVN0cmF0ZWd5IGV4dGVuZHMgWm9vbVN0cmF0ZWd5IGltcGxlbWVudHMgU3RyYXRlZ3kge1xuICBjb25zdHJ1Y3RvcihcbiAgICB2aWV3ZXI6IGFueSxcbiAgICBjYW52YXNTZXJ2aWNlOiBDYW52YXNTZXJ2aWNlLFxuICAgIG1vZGVTZXJ2aWNlOiBNb2RlU2VydmljZSxcbiAgICB2aWV3ZXJMYXlvdXRTZXJ2aWNlOiBWaWV3ZXJMYXlvdXRTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKHZpZXdlciwgY2FudmFzU2VydmljZSwgbW9kZVNlcnZpY2UsIHZpZXdlckxheW91dFNlcnZpY2UpO1xuICB9XG59XG4iXX0=