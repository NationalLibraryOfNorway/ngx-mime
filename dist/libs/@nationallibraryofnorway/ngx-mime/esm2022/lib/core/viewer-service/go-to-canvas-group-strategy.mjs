import { Direction } from '../models/direction';
import { ViewerMode } from '../models/viewer-mode';
import { ViewerOptions } from '../models/viewer-options';
import { ViewingDirection } from '../models/viewing-direction';
import { CalculateNextCanvasGroupFactory } from './calculate-next-canvas-group-factory';
export class DefaultGoToCanvasGroupStrategy {
    constructor(viewer, zoomStrategy, canvasService, modeService, config, viewingDirection) {
        this.viewer = viewer;
        this.zoomStrategy = zoomStrategy;
        this.canvasService = canvasService;
        this.modeService = modeService;
        this.config = config;
        this.viewingDirection = viewingDirection;
    }
    goToCanvasGroup(canvasGroup) {
        const oldCanvasGroupIndex = this.canvasService.currentCanvasGroupIndex;
        this.canvasService.currentCanvasGroupIndex =
            this.canvasService.constrainToRange(canvasGroup.canvasGroupIndex);
        const newCanvasGroup = this.canvasService.getCanvasGroupRect(this.canvasService.currentCanvasGroupIndex);
        if (this.modeService.isPageZoomed() &&
            this.config.preserveZoomOnCanvasGroupChange) {
            let x;
            if (oldCanvasGroupIndex > canvasGroup.canvasGroupIndex) {
                if (this.config.startOnTopOnCanvasGroupChange) {
                    const canvasGroupIndexes = this.canvasService.getCanvasesPerCanvasGroup(canvasGroup.canvasGroupIndex);
                    const previousCanvasIndex = canvasGroupIndexes[canvasGroupIndexes.length - 1];
                    const previousCanvasRect = this.canvasService.getCanvasRect(previousCanvasIndex);
                    x =
                        this.viewingDirection === ViewingDirection.LTR
                            ? this.leftX(previousCanvasRect)
                            : this.rightX(newCanvasGroup);
                }
                else {
                    x =
                        this.viewingDirection === ViewingDirection.LTR
                            ? this.rightX(newCanvasGroup)
                            : this.leftX(newCanvasGroup);
                }
            }
            else {
                x =
                    this.viewingDirection === ViewingDirection.LTR
                        ? this.leftX(newCanvasGroup)
                        : this.rightX(newCanvasGroup);
            }
            const y = this.config.startOnTopOnCanvasGroupChange &&
                oldCanvasGroupIndex !== canvasGroup.canvasGroupIndex
                ? newCanvasGroup.y +
                    this.getViewportBounds().height / 2 -
                    this.viewer.collectionTileMargin
                : this.getViewportCenter().y;
            this.panTo(x, y, canvasGroup.immediately);
        }
        else if (this.modeService.isPageZoomed()) {
            const oldCanvasGroupCenter = this.canvasService.getCanvasGroupRect(oldCanvasGroupIndex);
            this.panToCenter(oldCanvasGroupCenter, canvasGroup.immediately);
            this.zoomStrategy.goToHomeZoom();
            setTimeout(() => {
                this.panToCenter(newCanvasGroup, canvasGroup.immediately);
                this.modeService.mode = ViewerMode.PAGE;
            }, ViewerOptions.transitions.OSDAnimationTime);
        }
        else {
            this.panToCenter(newCanvasGroup, canvasGroup.immediately);
        }
    }
    goToPreviousCanvasGroup(currentCanvasIndex) {
        if (this.canvasService.currentCanvasGroupIndex > 0) {
            const viewportCenter = this.getViewportCenter();
            const currentCanvasGroupIndex = this.canvasService.findClosestCanvasGroupIndex(viewportCenter);
            const calculateNextCanvasGroupStrategy = CalculateNextCanvasGroupFactory.create(ViewerMode.NAVIGATOR);
            const newCanvasGroupIndex = calculateNextCanvasGroupStrategy.calculateNextCanvasGroup({
                direction: Direction.PREVIOUS,
                currentCanvasGroupIndex: currentCanvasGroupIndex,
                currentCanvasGroupCenter: currentCanvasIndex,
                viewingDirection: this.viewingDirection,
            });
            this.goToCanvasGroup({
                canvasGroupIndex: newCanvasGroupIndex,
                immediately: false,
            });
        }
    }
    goToNextCanvasGroup(currentCanvasIndex) {
        if (this.canvasService.currentCanvasGroupIndex <
            this.canvasService.numberOfCanvasGroups) {
            const viewportCenter = this.getViewportCenter();
            const currentCanvasGroupIndex = this.canvasService.findClosestCanvasGroupIndex(viewportCenter);
            const calculateNextCanvasGroupStrategy = CalculateNextCanvasGroupFactory.create(ViewerMode.NAVIGATOR);
            const newCanvasGroupIndex = calculateNextCanvasGroupStrategy.calculateNextCanvasGroup({
                direction: Direction.NEXT,
                currentCanvasGroupIndex: currentCanvasGroupIndex,
                currentCanvasGroupCenter: currentCanvasIndex,
                viewingDirection: this.viewingDirection,
            });
            this.goToCanvasGroup({
                canvasGroupIndex: newCanvasGroupIndex,
                immediately: false,
            });
        }
    }
    centerCurrentCanvas() {
        const currentCanvasGroupIndex = this.canvasService.currentCanvasGroupIndex;
        const currentCanvasGroupCenter = this.canvasService.getCanvasGroupRect(currentCanvasGroupIndex);
        this.panToCenter(currentCanvasGroupCenter, false);
    }
    leftX(canvas) {
        return canvas.x + this.getViewportBounds().width / 2;
    }
    rightX(canvas) {
        return canvas.x + canvas.width - this.getViewportBounds().width / 2;
    }
    panToCenter(canvasGroup, immediately = false) {
        this.panTo(canvasGroup.centerX, canvasGroup.centerY, immediately);
    }
    panTo(x, y, immediately = false) {
        this.viewer.viewport.panTo({
            x: x,
            y: y,
        }, immediately);
    }
    getViewportCenter() {
        return this.viewer.viewport.getCenter(true);
    }
    getViewportBounds() {
        return this.viewer.viewport.getBounds(true);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ28tdG8tY2FudmFzLWdyb3VwLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvdmlld2VyLXNlcnZpY2UvZ28tdG8tY2FudmFzLWdyb3VwLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBZ0J4RixNQUFNLE9BQU8sOEJBQThCO0lBQ3pDLFlBQ1UsTUFBVyxFQUNYLFlBQXNCLEVBQ3RCLGFBQTRCLEVBQzVCLFdBQXdCLEVBQ3hCLE1BQXdCLEVBQ3hCLGdCQUFrQztRQUxsQyxXQUFNLEdBQU4sTUFBTSxDQUFLO1FBQ1gsaUJBQVksR0FBWixZQUFZLENBQVU7UUFDdEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBa0I7UUFDeEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtJQUN6QyxDQUFDO0lBRUosZUFBZSxDQUFDLFdBQXdCO1FBQ3RDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQztRQUN2RSxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QjtZQUN4QyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FB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Q0FBQyxRQUFRLENBQUMsS0FBSyxDQUN4QjtZQUNFLENBQUMsRUFBRSxDQUFDO1lBQ0osQ0FBQyxFQUFFLENBQUM7U0FDTCxFQUNELFdBQVcsQ0FDWixDQUFDO0lBQ0osQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhbnZhc1NlcnZpY2UgfSBmcm9tICcuLi9jYW52YXMtc2VydmljZS9jYW52YXMtc2VydmljZSc7XG5pbXBvcnQgeyBNaW1lVmlld2VyQ29uZmlnIH0gZnJvbSAnLi4vbWltZS12aWV3ZXItY29uZmlnJztcbmltcG9ydCB7IE1vZGVTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZS1zZXJ2aWNlL21vZGUuc2VydmljZSc7XG5pbXBvcnQgeyBEaXJlY3Rpb24gfSBmcm9tICcuLi9tb2RlbHMvZGlyZWN0aW9uJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vbW9kZWxzL3BvaW50JztcbmltcG9ydCB7IFJlY3QgfSBmcm9tICcuLi9tb2RlbHMvcmVjdCc7XG5pbXBvcnQgeyBWaWV3ZXJNb2RlIH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1tb2RlJztcbmltcG9ydCB7IFZpZXdlck9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbHMvdmlld2VyLW9wdGlvbnMnO1xuaW1wb3J0IHsgVmlld2luZ0RpcmVjdGlvbiB9IGZyb20gJy4uL21vZGVscy92aWV3aW5nLWRpcmVjdGlvbic7XG5pbXBvcnQgeyBDYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXBGYWN0b3J5IH0gZnJvbSAnLi9jYWxjdWxhdGUtbmV4dC1jYW52YXMtZ3JvdXAtZmFjdG9yeSc7XG5pbXBvcnQgeyBTdHJhdGVneSB9IGZyb20gJy4vem9vbS1zdHJhdGVneSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FudmFzR3JvdXAge1xuICBjYW52YXNHcm91cEluZGV4OiBudW1iZXI7XG4gIGRpcmVjdGlvbj86IERpcmVjdGlvbjtcbiAgaW1tZWRpYXRlbHk/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdvVG9DYW52YXNHcm91cFN0cmF0ZWd5IHtcbiAgZ29Ub0NhbnZhc0dyb3VwKGNhbnZhc0dyb3VwOiBDYW52YXNHcm91cCk6IHZvaWQ7XG4gIGdvVG9QcmV2aW91c0NhbnZhc0dyb3VwKGN1cnJlbnRDYW52YXNJbmRleDogbnVtYmVyKTogdm9pZDtcbiAgZ29Ub05leHRDYW52YXNHcm91cChjdXJyZW50Q2FudmFzSW5kZXg6IG51bWJlcik6IHZvaWQ7XG4gIGNlbnRlckN1cnJlbnRDYW52YXMoKTogdm9pZDtcbn1cblxuZXhwb3J0IGNsYXNzIERlZmF1bHRHb1RvQ2FudmFzR3JvdXBTdHJhdGVneSBpbXBsZW1lbnRzIEdvVG9DYW52YXNHcm91cFN0cmF0ZWd5IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB2aWV3ZXI6IGFueSxcbiAgICBwcml2YXRlIHpvb21TdHJhdGVneTogU3RyYXRlZ3ksXG4gICAgcHJpdmF0ZSBjYW52YXNTZXJ2aWNlOiBDYW52YXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgbW9kZVNlcnZpY2U6IE1vZGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgY29uZmlnOiBNaW1lVmlld2VyQ29uZmlnLFxuICAgIHByaXZhdGUgdmlld2luZ0RpcmVjdGlvbjogVmlld2luZ0RpcmVjdGlvblxuICApIHt9XG5cbiAgZ29Ub0NhbnZhc0dyb3VwKGNhbnZhc0dyb3VwOiBDYW52YXNHcm91cCkge1xuICAgIGNvbnN0IG9sZENhbnZhc0dyb3VwSW5kZXggPSB0aGlzLmNhbnZhc1NlcnZpY2UuY3VycmVudENhbnZhc0dyb3VwSW5kZXg7XG4gICAgdGhpcy5jYW52YXNTZXJ2aWNlLmN1cnJlbnRDYW52YXNHcm91cEluZGV4ID1cbiAgICAgIHRoaXMuY2FudmFzU2VydmljZS5jb25zdHJhaW5Ub1JhbmdlKGNhbnZhc0dyb3VwLmNhbnZhc0dyb3VwSW5kZXgpO1xuICAgIGNvbnN0IG5ld0NhbnZhc0dyb3VwID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldENhbnZhc0dyb3VwUmVjdChcbiAgICAgIHRoaXMuY2FudmFzU2VydmljZS5jdXJyZW50Q2FudmFzR3JvdXBJbmRleFxuICAgICk7XG4gICAgaWYgKFxuICAgICAgdGhpcy5tb2RlU2VydmljZS5pc1BhZ2Vab29tZWQoKSAmJlxuICAgICAgdGhpcy5jb25maWcucHJlc2VydmVab29tT25DYW52YXNHcm91cENoYW5nZVxuICAgICkge1xuICAgICAgbGV0IHg6IG51bWJlcjtcblxuICAgICAgaWYgKG9sZENhbnZhc0dyb3VwSW5kZXggPiBjYW52YXNHcm91cC5jYW52YXNHcm91cEluZGV4KSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5zdGFydE9uVG9wT25DYW52YXNHcm91cENoYW5nZSkge1xuICAgICAgICAgIGNvbnN0IGNhbnZhc0dyb3VwSW5kZXhlcyA9XG4gICAgICAgICAgICB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzZXNQZXJDYW52YXNHcm91cChcbiAgICAgICAgICAgICAgY2FudmFzR3JvdXAuY2FudmFzR3JvdXBJbmRleFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBwcmV2aW91c0NhbnZhc0luZGV4ID1cbiAgICAgICAgICAgIGNhbnZhc0dyb3VwSW5kZXhlc1tjYW52YXNHcm91cEluZGV4ZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgY29uc3QgcHJldmlvdXNDYW52YXNSZWN0ID1cbiAgICAgICAgICAgIHRoaXMuY2FudmFzU2VydmljZS5nZXRDYW52YXNSZWN0KHByZXZpb3VzQ2FudmFzSW5kZXgpO1xuICAgICAgICAgIHggPVxuICAgICAgICAgICAgdGhpcy52aWV3aW5nRGlyZWN0aW9uID09PSBWaWV3aW5nRGlyZWN0aW9uLkxUUlxuICAgICAgICAgICAgICA/IHRoaXMubGVmdFgocHJldmlvdXNDYW52YXNSZWN0KVxuICAgICAgICAgICAgICA6IHRoaXMucmlnaHRYKG5ld0NhbnZhc0dyb3VwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB4ID1cbiAgICAgICAgICAgIHRoaXMudmlld2luZ0RpcmVjdGlvbiA9PT0gVmlld2luZ0RpcmVjdGlvbi5MVFJcbiAgICAgICAgICAgICAgPyB0aGlzLnJpZ2h0WChuZXdDYW52YXNHcm91cClcbiAgICAgICAgICAgICAgOiB0aGlzLmxlZnRYKG5ld0NhbnZhc0dyb3VwKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgeCA9XG4gICAgICAgICAgdGhpcy52aWV3aW5nRGlyZWN0aW9uID09PSBWaWV3aW5nRGlyZWN0aW9uLkxUUlxuICAgICAgICAgICAgPyB0aGlzLmxlZnRYKG5ld0NhbnZhc0dyb3VwKVxuICAgICAgICAgICAgOiB0aGlzLnJpZ2h0WChuZXdDYW52YXNHcm91cCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHkgPVxuICAgICAgICB0aGlzLmNvbmZpZy5zdGFydE9uVG9wT25DYW52YXNHcm91cENoYW5nZSAmJlxuICAgICAgICBvbGRDYW52YXNHcm91cEluZGV4ICE9PSBjYW52YXNHcm91cC5jYW52YXNHcm91cEluZGV4XG4gICAgICAgICAgPyBuZXdDYW52YXNHcm91cC55ICtcbiAgICAgICAgICAgIHRoaXMuZ2V0Vmlld3BvcnRCb3VuZHMoKS5oZWlnaHQgLyAyIC1cbiAgICAgICAgICAgIHRoaXMudmlld2VyLmNvbGxlY3Rpb25UaWxlTWFyZ2luXG4gICAgICAgICAgOiB0aGlzLmdldFZpZXdwb3J0Q2VudGVyKCkueTtcblxuICAgICAgdGhpcy5wYW5Ubyh4LCB5LCBjYW52YXNHcm91cC5pbW1lZGlhdGVseSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLm1vZGVTZXJ2aWNlLmlzUGFnZVpvb21lZCgpKSB7XG4gICAgICBjb25zdCBvbGRDYW52YXNHcm91cENlbnRlciA9XG4gICAgICAgIHRoaXMuY2FudmFzU2VydmljZS5nZXRDYW52YXNHcm91cFJlY3Qob2xkQ2FudmFzR3JvdXBJbmRleCk7XG4gICAgICB0aGlzLnBhblRvQ2VudGVyKG9sZENhbnZhc0dyb3VwQ2VudGVyLCBjYW52YXNHcm91cC5pbW1lZGlhdGVseSk7XG4gICAgICB0aGlzLnpvb21TdHJhdGVneS5nb1RvSG9tZVpvb20oKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnBhblRvQ2VudGVyKG5ld0NhbnZhc0dyb3VwLCBjYW52YXNHcm91cC5pbW1lZGlhdGVseSk7XG4gICAgICAgIHRoaXMubW9kZVNlcnZpY2UubW9kZSA9IFZpZXdlck1vZGUuUEFHRTtcbiAgICAgIH0sIFZpZXdlck9wdGlvbnMudHJhbnNpdGlvbnMuT1NEQW5pbWF0aW9uVGltZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGFuVG9DZW50ZXIobmV3Q2FudmFzR3JvdXAsIGNhbnZhc0dyb3VwLmltbWVkaWF0ZWx5KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ29Ub1ByZXZpb3VzQ2FudmFzR3JvdXAoY3VycmVudENhbnZhc0luZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jYW52YXNTZXJ2aWNlLmN1cnJlbnRDYW52YXNHcm91cEluZGV4ID4gMCkge1xuICAgICAgY29uc3Qgdmlld3BvcnRDZW50ZXIgPSB0aGlzLmdldFZpZXdwb3J0Q2VudGVyKCk7XG4gICAgICBjb25zdCBjdXJyZW50Q2FudmFzR3JvdXBJbmRleCA9XG4gICAgICAgIHRoaXMuY2FudmFzU2VydmljZS5maW5kQ2xvc2VzdENhbnZhc0dyb3VwSW5kZXgodmlld3BvcnRDZW50ZXIpO1xuXG4gICAgICBjb25zdCBjYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXBTdHJhdGVneSA9XG4gICAgICAgIENhbGN1bGF0ZU5leHRDYW52YXNHcm91cEZhY3RvcnkuY3JlYXRlKFZpZXdlck1vZGUuTkFWSUdBVE9SKTtcbiAgICAgIGNvbnN0IG5ld0NhbnZhc0dyb3VwSW5kZXggPVxuICAgICAgICBjYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXBTdHJhdGVneS5jYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXAoe1xuICAgICAgICAgIGRpcmVjdGlvbjogRGlyZWN0aW9uLlBSRVZJT1VTLFxuICAgICAgICAgIGN1cnJlbnRDYW52YXNHcm91cEluZGV4OiBjdXJyZW50Q2FudmFzR3JvdXBJbmRleCxcbiAgICAgICAgICBjdXJyZW50Q2FudmFzR3JvdXBDZW50ZXI6IGN1cnJlbnRDYW52YXNJbmRleCxcbiAgICAgICAgICB2aWV3aW5nRGlyZWN0aW9uOiB0aGlzLnZpZXdpbmdEaXJlY3Rpb24sXG4gICAgICAgIH0pO1xuICAgICAgdGhpcy5nb1RvQ2FudmFzR3JvdXAoe1xuICAgICAgICBjYW52YXNHcm91cEluZGV4OiBuZXdDYW52YXNHcm91cEluZGV4LFxuICAgICAgICBpbW1lZGlhdGVseTogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ29Ub05leHRDYW52YXNHcm91cChjdXJyZW50Q2FudmFzSW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIHRoaXMuY2FudmFzU2VydmljZS5jdXJyZW50Q2FudmFzR3JvdXBJbmRleCA8XG4gICAgICB0aGlzLmNhbnZhc1NlcnZpY2UubnVtYmVyT2ZDYW52YXNHcm91cHNcbiAgICApIHtcbiAgICAgIGNvbnN0IHZpZXdwb3J0Q2VudGVyID0gdGhpcy5nZXRWaWV3cG9ydENlbnRlcigpO1xuICAgICAgY29uc3QgY3VycmVudENhbnZhc0dyb3VwSW5kZXggPVxuICAgICAgICB0aGlzLmNhbnZhc1NlcnZpY2UuZmluZENsb3Nlc3RDYW52YXNHcm91cEluZGV4KHZpZXdwb3J0Q2VudGVyKTtcblxuICAgICAgY29uc3QgY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwU3RyYXRlZ3kgPVxuICAgICAgICBDYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXBGYWN0b3J5LmNyZWF0ZShWaWV3ZXJNb2RlLk5BVklHQVRPUik7XG4gICAgICBjb25zdCBuZXdDYW52YXNHcm91cEluZGV4ID1cbiAgICAgICAgY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwU3RyYXRlZ3kuY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwKHtcbiAgICAgICAgICBkaXJlY3Rpb246IERpcmVjdGlvbi5ORVhULFxuICAgICAgICAgIGN1cnJlbnRDYW52YXNHcm91cEluZGV4OiBjdXJyZW50Q2FudmFzR3JvdXBJbmRleCxcbiAgICAgICAgICBjdXJyZW50Q2FudmFzR3JvdXBDZW50ZXI6IGN1cnJlbnRDYW52YXNJbmRleCxcbiAgICAgICAgICB2aWV3aW5nRGlyZWN0aW9uOiB0aGlzLnZpZXdpbmdEaXJlY3Rpb24sXG4gICAgICAgIH0pO1xuICAgICAgdGhpcy5nb1RvQ2FudmFzR3JvdXAoe1xuICAgICAgICBjYW52YXNHcm91cEluZGV4OiBuZXdDYW52YXNHcm91cEluZGV4LFxuICAgICAgICBpbW1lZGlhdGVseTogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2VudGVyQ3VycmVudENhbnZhcygpOiB2b2lkIHtcbiAgICBjb25zdCBjdXJyZW50Q2FudmFzR3JvdXBJbmRleCA9IHRoaXMuY2FudmFzU2VydmljZS5jdXJyZW50Q2FudmFzR3JvdXBJbmRleDtcbiAgICBjb25zdCBjdXJyZW50Q2FudmFzR3JvdXBDZW50ZXIgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzR3JvdXBSZWN0KFxuICAgICAgY3VycmVudENhbnZhc0dyb3VwSW5kZXhcbiAgICApO1xuICAgIHRoaXMucGFuVG9DZW50ZXIoY3VycmVudENhbnZhc0dyb3VwQ2VudGVyLCBmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGxlZnRYKGNhbnZhczogUmVjdCk6IG51bWJlciB7XG4gICAgcmV0dXJuIGNhbnZhcy54ICsgdGhpcy5nZXRWaWV3cG9ydEJvdW5kcygpLndpZHRoIC8gMjtcbiAgfVxuXG4gIHByaXZhdGUgcmlnaHRYKGNhbnZhczogUmVjdCk6IG51bWJlciB7XG4gICAgcmV0dXJuIGNhbnZhcy54ICsgY2FudmFzLndpZHRoIC0gdGhpcy5nZXRWaWV3cG9ydEJvdW5kcygpLndpZHRoIC8gMjtcbiAgfVxuXG4gIHByaXZhdGUgcGFuVG9DZW50ZXIoY2FudmFzR3JvdXA6IFJlY3QsIGltbWVkaWF0ZWx5ID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLnBhblRvKGNhbnZhc0dyb3VwLmNlbnRlclgsIGNhbnZhc0dyb3VwLmNlbnRlclksIGltbWVkaWF0ZWx5KTtcbiAgfVxuXG4gIHByaXZhdGUgcGFuVG8oeDogbnVtYmVyLCB5OiBudW1iZXIsIGltbWVkaWF0ZWx5ID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLnZpZXdlci52aWV3cG9ydC5wYW5UbyhcbiAgICAgIHtcbiAgICAgICAgeDogeCxcbiAgICAgICAgeTogeSxcbiAgICAgIH0sXG4gICAgICBpbW1lZGlhdGVseVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFZpZXdwb3J0Q2VudGVyKCk6IFBvaW50IHtcbiAgICByZXR1cm4gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Q2VudGVyKHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRWaWV3cG9ydEJvdW5kcygpOiBSZWN0IHtcbiAgICByZXR1cm4gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Qm91bmRzKHRydWUpO1xuICB9XG59XG4iXX0=